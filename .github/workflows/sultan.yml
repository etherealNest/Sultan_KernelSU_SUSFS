name: Sultan
permissions:
  contents: write
  actions: write

on:
  workflow_call:
    inputs:
      codename:
        required: true
        type: string
      repo:
        required: true
        type: string
      android_version:
        required: true
        type: string
      kernel_version:
        required: true
        type: string
      ksu_type:
        required: true
        type: string
  
jobs:
  build-kernel-sultan-kernelsu-susfs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download and extract GCC 14.2.0 toolchain
        run: |
          echo "Downloading GCC 14.2.0 cross-compiler toolchain..."
          wget https://www.kernel.org/pub/tools/crosstool/files/bin/x86_64/14.2.0/x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar.gz
          echo "Extracting .gz file..."
          gunzip x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar.gz
          echo "Extracting .tar file..."
          tar -xf x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar
          echo "GCC 14.2.0 toolchain extracted successfully"

      - name: Umgebungsvariable setzen
        run: |
          cat >> $GITHUB_ENV << EOF
          KERNEL_ROOT=$GITHUB_WORKSPACE/android_kernel_google_zuma
          DEFCONFIG_PATH="$GITHUB_WORKSPACE/android_kernel_google_zuma/arch/arm64/configs/zuma_defconfig"
          EOF

      - name: Klonen AnyKernel3 und andere Abh√§ngigkeiten
        run: |
          git clone https://github.com/TheWildJames/AnyKernel3.git -b "sultan-zuma"
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b "gki-android14-6.1"
          git clone https://github.com/TheWildJames/kernel_patches.git
          git clone https://github.com/kerneltoast/android_kernel_google_zuma --depth=1
          git clone https://github.com/Anatdx/HymoFS -b "android14_6.1"

      - name: KSU f√ºgen hinzu
        run: |
          cd "${{ env.KERNEL_ROOT }}"
          if [ "${{ inputs.ksu_type }}" == "ksu-next" ]; then
            echo "  ‚û°Ô∏è Hinzuf√ºngen KernelSU..."
            curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -s dev
          elif [ "${{ inputs.ksu_type }}" == "suki-su" ]; then
            echo "  ‚û°Ô∏è Hinzuf√ºngen Suki-SU..."
            curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s builtin
          fi

      - name: Anwendung SUSFS Patches
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |                   
          # Kopieren SUSFS patches
          cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch ./
          cp ../kernel_patches/sultan/sys.c_fix.patch ./
          cp ../susfs4ksu/kernel_patches/fs/* ./fs/
          cp ../susfs4ksu/kernel_patches/include/linux/* ./include/linux/

          if [ "${{ inputs.ksu_type }}" == "ksu-next" ]; then
            cd KernelSU-Next

            echo "  ‚û°Ô∏è Anwendung 10_enable_susfs_for_ksu.patch"
            cp $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./
            patch -p1 < 10_enable_susfs_for_ksu.patch || true

          # Verifying file hashes before applying further patches
          CHECKSUMS="492e74b5d9accf1f154c9fa169c81b3eb6f886b478e43574ff8753530edeb838  ./kernel/allowlist.c
          80a36414db4266fa61da7efd6205326d25627d097cdd00938d95ead58c2515ea  ./kernel/apk_sign.c
          623a1cd3fce77124858b813169a91b4a60e3e2409b5501c7c8c06070480e933d  ./kernel/ksud.c
          8d430ea63e16fcb9cd0acfb720306b4c9c4e2033100bb5e28eaa441aa068a521  ./kernel/selinux/selinux.c
          b001ce779d25e98dcd01fc8850e5f2d1e078cddf75928a61bfc0bb6f88796e0b  ./kernel/sucompat.c
          cc05d793e83d6b372005474e075b6ac3b2b4207fc0da4feecca9447b0295bf5d  ./kernel/setuid_hook.c
          57388ad2cb272a85aa4ed0c621fec4c938214d88bc25dea12cf7c4ab760636f4  ./kernel/Makefile
          85397314f04352986eb92188eab8498306581adae864f80dc5604ad58332da50  ./kernel/ksu.c
          71033df2afbab5d7f72f5fdcbd150b1f4f7769460adcc6ebc4127e7340159f67  ./kernel/supercalls.c
          f7b7917fd10815a4fab8013139363aede2422cdfc3e17858fde54cf2310b18c6  ./kernel/kernel_umount.c"

          while read -r H F; do
            [ -z "$F" ] && continue
            if [ "$(sha256sum "$F" | awk '{print $1}')" = "$H" ]; then
              echo "‚úÖ$F COINCIDENCE"
            else
              echo "‚ùå$F MISCOVERY"
              STATUS_SHA="dirty"
              echo "STATUS_SHA=$STATUS_SHA" >> $GITHUB_ENV
            fi
          done <<< "$CHECKSUMS"

            echo "  üõ†Ô∏è Wir reparieren, was den vorherigen Patch gebrochen hat. "
            cp $GITHUB_WORKSPACE/patches/ksu-next_susfs-v2.0.0/*.patch ./

            echo "  ‚û°Ô∏è Korrigieren fix_allowlist.c.patch"
            patch -p1 < fix_allowlist.c.patch
            echo "  ‚û°Ô∏è Korrigieren fix_apk_sign.c.patch"
            patch -p1 < fix_apk_sign.c.patch
            echo "  ‚û°Ô∏è Korrigieren fix_kernel_umount.c.patch"
            patch -p1 < fix_kernel_umount.c.patch
            echo "  ‚û°Ô∏è Korrigieren fix_ksu.c.patch"
            patch -p1 < fix_ksu.c.patch
            echo "  ‚û°Ô∏è Korrigieren fix_ksud.c.patch"
            patch -p1 < fix_ksud.c.patch
            echo "  ‚û°Ô∏è Korrigieren fix_Makefile.patch"
            patch -p1 < fix_Makefile.patch
            echo "  ‚û°Ô∏è Korrigieren fix_selinux.c.patch"
            patch -p1 < fix_selinux.c.patch
            echo "  ‚û°Ô∏è Korrigieren fix_setuid_hook.c.patch"
            patch -p1 < fix_setuid_hook.c.patch
            echo "  ‚û°Ô∏è Korrigieren fix_sucompat.c.patch"
            patch -p1 < fix_sucompat.c.patch
            echo "  ‚û°Ô∏è Korrigieren fix_supercalls.c.patch"
            patch -p1 < fix_supercalls.c.patch

            cd ..
          fi

          echo "  ‚û°Ô∏è Anwendung 50_add_susfs_in_gki-android14-6.1.patch"
          patch -p1 < 50_add_susfs_in_gki-android14-6.1.patch || true
          echo "  üõ†Ô∏è Wir reparieren, was den vorherigen Patch gebrochen hat."
          echo "  ‚û°Ô∏è Korrigieren sys.c_fix.patch"
          patch -p1 --fuzz=3 < sys.c_fix.patch

      - name: Eigene Signatur f√ºgen hinzu
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          if [ "${{ inputs.ksu_type }}" == "suki-su" ]; then
            echo "tempor√§r √ºberspringen"
            # cd KernelSU
            # sed -i -e 's/^\(#define EXPECTED_SIZE_NEKO\s\+\).*/\1916/' \
            #          -e 's/^\(#define EXPECTED_HASH_NEKO\s\+\).*/\1"a72f1296cd4b30901e9c57858d5ce185339e3dde7a91b41a0f2cdf39ffde45af"/' \
            #          kernel/manager_sign.h
          elif [ "${{ inputs.ksu_type }}" == "ksu-next" ]; then
            echo "Dies wurde bereits bei der Anwendung von fix_apk_sign getan.c.patch"
          fi

      - name: KernelSU-Version ermitteln
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          if [ "${{ inputs.ksu_type }}" == "ksu-next" ]; then
            cd "KernelSU-Next/kernel"
            BASE_VERSION=30000
            COMMIT_COUNT=$(/usr/bin/git rev-list --count origin/dev)
          elif [ "${{ inputs.ksu_type }}" == "suki-su" ]; then
            cd "KernelSU/kernel"
            BASE_VERSION=10700
            COMMIT_COUNT=$(/usr/bin/git rev-list --count origin/HEAD)
          fi

          KSU_VERSION=$(expr $COMMIT_COUNT "+" $BASE_VERSION)
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV

      - name: √úberpr√ºfen der Kernel-Version
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          KERNEL_VER=$(sed -n '2,4p' Makefile | grep -oE '[0-9]+' | paste -sd '.')
          echo "KERNEL_VER=$KERNEL_VER" >> $GITHUB_ENV

          echo "Kernel version detected: ${KERNEL_VER}"

      - name: BBG f√ºgen hinzu
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash
          echo "CONFIG_BBG=y" >> ${{ env.DEFCONFIG_PATH }}
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' security/Kconfig

      - name: Kernel-Optionen konfigurieren
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          if [ "${{ inputs.ksu_type }}" == "ksu-next" ]; then
            cat $GITHUB_WORKSPACE/defconfigs/ksu-next >> "${{ env.DEFCONFIG_PATH }}"
          elif [ "${{ inputs.ksu_type }}" == "suki-su" ]; then
            cat $GITHUB_WORKSPACE/defconfigs/suki-su >> "${{ env.DEFCONFIG_PATH }}"
          fi

          cat >> "${{ env.DEFCONFIG_PATH }}" << 'EOF'
          # KernelSU Configuration
          CONFIG_KSU=y
          CONFIG_KSU_KPROBES_HOOK=n

          # Mountify Support
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y

          # Networking Configuration
          CONFIG_IP_NF_TARGET_TTL=y
          CONFIG_IP6_NF_TARGET_HL=y
          CONFIG_IP6_NF_MATCH_HL=y

          # BBR TCP Congestion Control
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_NET_SCH_FQ=y
          CONFIG_TCP_CONG_BIC=n
          CONFIG_TCP_CONG_WESTWOOD=n
          CONFIG_TCP_CONG_HTCP=n

          # IPSet Support
          CONFIG_IP_SET=y
          CONFIG_IP_SET_MAX=65534
          CONFIG_IP_SET_BITMAP_IP=y
          CONFIG_IP_SET_BITMAP_IPMAC=y
          CONFIG_IP_SET_BITMAP_PORT=y
          CONFIG_IP_SET_HASH_IP=y
          CONFIG_IP_SET_HASH_IPMARK=y
          CONFIG_IP_SET_HASH_IPPORT=y
          CONFIG_IP_SET_HASH_IPPORTIP=y
          CONFIG_IP_SET_HASH_IPPORTNET=y
          CONFIG_IP_SET_HASH_IPMAC=y
          CONFIG_IP_SET_HASH_MAC=y
          CONFIG_IP_SET_HASH_NETPORTNET=y
          CONFIG_IP_SET_HASH_NET=y
          CONFIG_IP_SET_HASH_NETNET=y
          CONFIG_IP_SET_HASH_NETPORT=y
          CONFIG_IP_SET_HASH_NETIFACE=y
          CONFIG_IP_SET_LIST_SET=y

          CONFIG_KSU_SUSFS=y
          THREAD_INFO_IN_TASK=y
          EOF

          # Removing defconfig check
          sed -i 's/check_defconfig//' ./build.config.gki

      - name: HymoFS
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          patch -p1 < $GITHUB_WORKSPACE/HymoFS/patch/hymofs_with_susfs.patch | true
          echo "  ‚û°Ô∏è Korrigieren fix_Makefile.patch"
          patch -p1 < $GITHUB_WORKSPACE/patch/hymofs/fix_Makefile.patch
          cat >> "${{ env.DEFCONFIG_PATH }}" << 'EOF'
          CONFIG_HYMOFS=y
          EOF

      - name: Anwenden von Leistungspatches
        run: |
          cd "${{ env.KERNEL_ROOT }}"
          cp "../kernel_patches/common/optimized_mem_operations.patch" ./
          patch -p1 --forward < optimized_mem_operations.patch
          cp "../kernel_patches/common/file_struct_8bytes_align.patch" ./
          patch -p1 --forward < file_struct_8bytes_align.patch
          cp "../kernel_patches/common/reduce_cache_pressure.patch" ./
          patch -p1 --forward < reduce_cache_pressure.patch
          cp "../kernel_patches/common/clear_page_16bytes_align.patch" ./
          sed -e 's/SYM_FUNC_START_PI(clear_page)/SYM_FUNC_START_PI(__pi_clear_page)/' clear_page_16bytes_align.patch > clear_page_16bytes_align__pi.patch
          patch -p1 -F3 --forward < clear_page_16bytes_align__pi.patch

#      - name: Start VS Code
#        uses: fawazahmed0/action-debug-vscode@main

      - name: √Ñnderung des Namens in standart
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          # Removing the "dirty" label
          sed -i "s/printf '%s' -dirty/printf '%s'/" scripts/setlocalversion
          sed -i 's/android_release=/android_release="android14-6.1"/' scripts/setlocalversion
          sed -i 's/# CONFIG_LOCALVERSION_AUTO is not set/CONFIG_LOCALVERSION_AUTO=y/' ${{ env.DEFCONFIG_PATH }}
          sed -i '/CONFIG_LOCALVERSION="-Sultan"/d' ${{ env.DEFCONFIG_PATH }}

      - name: Das Kernel bauen
        run: |
          cd "${{ env.KERNEL_ROOT }}"
          
          # Disable the generation of a fatal error when making warnings.
          echo "# CONFIG_WERROR is not set" >> "${{ env.DEFCONFIG_PATH }}"

          make CROSS_COMPILE=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux- CC=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-gcc -j$(nproc --all) zuma_defconfig
          make CROSS_COMPILE=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux- CC=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-gcc -j$(nproc --all)

      - name: Images kopieren
        working-directory: ${{ env.KERNEL_ROOT }}
        run: |
          # Copying Image.lz4 and concatenating DTB files
          cp ./out/arch/arm64/boot/Image.lz4 ../AnyKernel3/Image.lz4
          if [ "zuma" == "zuma" ]; then
            cat ./out/google-devices/zuma/dts/*.dtb > ../AnyKernel3/dtb
          fi

      - name: ZIP-Dateien erstellen
        run: |
          cd ./AnyKernel3

          # Zip the files in the AnyKernel3 directory with a new naming convention
          ZIP_NAME="${KERNEL_VER}-zuma-${{ inputs.ksu_type }}-v${{ env.KSUVER }}-AnyKernel3.zip"
          echo "Creating zip file $ZIP_NAME..."
          zip -r "../$ZIP_NAME" ./*

      - name: boot.img erstellen
        run: |
          set -x
          MAGISKBOOT=$GITHUB_WORKSPACE/prebuilds/magiskboot_v30.2
          chmod +x "$MAGISKBOOT"
          BOOTIMG=$GITHUB_WORKSPACE/prebuilds/boot.img
          VENDOR=$GITHUB_WORKSPACE/prebuilds/vendor_kernel_boot.img
          TMP_DIR=tmp_dir
          mkdir "${TMP_DIR}"

          BOOT_NAME="${KERNEL_VER}-zuma-${{ inputs.ksu_type }}-v${{ env.KSUVER }}-boot.img"
          VENDOR_BOOT_NAME="${KERNEL_VER}-zuma-${{ inputs.ksu_type }}-v${{ env.KSUVER }}-vendor_kernel_boot.img"

          unzip $GITHUB_WORKSPACE/prebuilds/stock_img_shusky.zip -d $GITHUB_WORKSPACE/prebuilds/

          cp ${{ env.KERNEL_ROOT }}/out/arch/arm64/boot/Image.lz4 ./
          cat ${{ env.KERNEL_ROOT }}/out/google-devices/zuma/dts/*.dtb > dtb
          
          cd tmp_dir
          "$MAGISKBOOT" unpack "$BOOTIMG"
          cp ../Image.lz4 kernel
          "$MAGISKBOOT" repack "$BOOTIMG" ../$BOOT_NAME
          rm -rf ./*
          "$MAGISKBOOT" unpack "$VENDOR"
          cp ../dtb dtb
          "$MAGISKBOOT" repack "$VENDOR" ../$VENDOR_BOOT_NAME
          
      - name: AK3.zip laden hoch
        uses: actions/upload-artifact@v4
        with:
          name: AK3-zuma-${{ inputs.ksu_type }}${{ env.STATUS_SHA }}
          path: |
            *.zip

      - name: img's laden hoch
        uses: actions/upload-artifact@v4
        with:
          name: flashable-img-zuma-${{ inputs.ksu_type }}${{ env.STATUS_SHA }}
          path: |
            *.img

      - name: Scan and collect patch rejects
        if: ${{ always() }}
        run: |
          set -e
          REJECTS_DIR="$GITHUB_WORKSPACE/patch-rejects"
          mkdir -p "$REJECTS_DIR"
          mapfile -t REJS < <(find "${{ env.KERNEL_ROOT }}" -type f -name '*.rej')
          REJ_COUNT=${#REJS[@]}
          echo "Found $REJ_COUNT .rej files under ${{ env.KERNEL_ROOT }}"
          echo "REJ_COUNT=$REJ_COUNT" >> $GITHUB_ENV
          if [ "$REJ_COUNT" -gt 0 ]; then
            for REJ in "${REJS[@]}"; do
              REL="${REJ#"${{ env.KERNEL_ROOT }}"/}"
              DEST="$REJECTS_DIR/$REL"
              mkdir -p "$(dirname "$DEST")"
              cp "$REJ" "$DEST"
              ORIG="${REJ%.rej}"
              if [ -f "$ORIG" ]; then
                ORIG_DEST="$REJECTS_DIR/${REL%.rej}"
                mkdir -p "$(dirname "$ORIG_DEST")"
                cp "$ORIG" "$ORIG_DEST"
              fi
              echo "$REL" >> "$REJECTS_DIR/index.txt"
            done
          fi

      - name: Zus√§tzliche Artefakte
        if: ${{ always() }}
        id: upload_misc
        uses: actions/upload-artifact@v4
        with:
          name: Misc-zuma-${{ inputs.ksu_type }}
          path: |
            patch-rejects/**
          if-no-files-found: ignore
          compression-level: 9