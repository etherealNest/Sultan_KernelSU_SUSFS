name: Sultan
permissions:
  contents: write
  actions: write

on:
  workflow_call:
    inputs:
      codename:
        required: true
        type: string
      repo:
        required: true
        type: string
      android_version:
        required: true
        type: string
      kernel_version:
        required: true
        type: string
      ksu_type:
        required: true
        type: string
  
jobs:
  build-kernel-sultan-kernelsu-susfs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download and extract GCC 14.2.0 toolchain
        run: |
          echo "Downloading GCC 14.2.0 cross-compiler toolchain..."
          wget https://www.kernel.org/pub/tools/crosstool/files/bin/x86_64/14.2.0/x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar.gz
          echo "Extracting .gz file..."
          gunzip x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar.gz
          echo "Extracting .tar file..."
          tar -xf x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar
          echo "GCC 14.2.0 toolchain extracted successfully"

      - name: Set CONFIG Environment Variable
        run: |
          CONFIG="${{ inputs.repo }}"
          
          # Set CONFIG as an environment variable for future steps
          echo "CONFIG=$CONFIG" >> $GITHUB_ENV
          
          echo "CONFIG set to: $CONFIG"

      - name: Clone AnyKernel3 and Other Dependencies
        run: |
          echo "Cloning AnyKernel3 and other dependencies..."
          
          ANYKERNEL_BRANCH="sultan-${{ inputs.codename }}"
          SUSFS_BRANCH="gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}"

          # Debug print the branches
          echo "Using branch for AnyKernel3: $ANYKERNEL_BRANCH"
          echo "Using branch for SUSFS: $SUSFS_BRANCH"

          # Clone repositories using the branch names
          git clone https://github.com/TheWildJames/AnyKernel3.git -b "$ANYKERNEL_BRANCH"
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b "$SUSFS_BRANCH"
          git clone https://github.com/TheWildJames/kernel_patches.git
          git clone https://github.com/kerneltoast/android_kernel_google_zuma --depth=1

      - name: Add KSU
        run: |
          cd "$CONFIG"
          if [ "${{ inputs.ksu_type }}" == "ksu-next" ]; then
            echo "  ‚û°Ô∏è Adding KernelSU..."
            curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -s dev
          elif [ "${{ inputs.ksu_type }}" == "suki-su" ]; then
            echo "  ‚û°Ô∏è Adding Suki-SU..."
            curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s susfs-main
          elif [ "${{ inputs.ksu_type }}" == "5ec1cff" ]; then
            echo "  ‚û°Ô∏è Adding 5ec1cff..."
            curl -LSs "https://raw.githubusercontent.com/5ec1cff/KernelSU/main/kernel/setup.sh" | bash -s main
          fi

      - name: Apply SUSFS Patches
        run: |
          cd "$CONFIG"
                    
          # Copy SUSFS patches
          cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch ./
          cp ../kernel_patches/sultan/sys.c_fix.patch ./
          cp ../susfs4ksu/kernel_patches/fs/* ./fs/
          cp ../susfs4ksu/kernel_patches/include/linux/* ./include/linux/

          if [ "${{ inputs.ksu_type }}" == "ksu-next" ]; then
            cd KernelSU-Next
            echo "üìÉ"
            ls -la
            echo "üìÉ"

            echo "  ‚û°Ô∏è –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ 10_enable_susfs_for_ksu.patch"
            cp ../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./
            patch -p1 < 10_enable_susfs_for_ksu.patch || true

            cp ../../patch/ksu-next/*.patch ./
            echo "  üõ†Ô∏è –ß–∏–Ω–∏–º —Ç–æ, —á—Ç–æ —Å–ª–æ–º–∞–ª –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–∞—Ç—á."

          CHECKSUMS="492e74b5d9accf1f154c9fa169c81b3eb6f886b478e43574ff8753530edeb838 ./kernel/allowlist.c
          80a36414db4266fa61da7efd6205326d25627d097cdd00938d95ead58c2515ea ./kernel/apk_sign.c
          623a1cd3fce77124858b813169a91b4a60e3e2409b5501c7c8c06070480e933d ./kernel/ksud.c
          8d430ea63e16fcb9cd0acfb720306b4c9c4e2033100bb5e28eaa441aa068a521 ./kernel/selinux/selinux.c
          b001ce779d25e98dcd01fc8850e5f2d1e078cddf75928a61bfc0bb6f88796e0b ./kernel/sucompat.c
          57388ad2cb272a85aa4ed0c621fec4c938214d88bc25dea12cf7c4ab760636f4 ./kernel/Makefile
          85397314f04352986eb92188eab8498306581adae864f80dc5604ad58332da50 ./kernel/ksu.c
          71033df2afbab5d7f72f5fdcbd150b1f4f7769460adcc6ebc4127e7340159f67 ./kernel/supercalls.c
          f7b7917fd10815a4fab8013139363aede2422cdfc3e17858fde54cf2310b18c6 ./kernel/kernel_umount.c"

          while read -r H F; do
            [ -z "$F" ] && continue
            if [ "$(sha256sum "$F" | awk '{print $1}')" = "$H" ]; then
              echo "‚úÖ$F COINCIDENCE"
            else
              echo "‚ùå$F MISCOVERY"
              STATUS_SHA="ACHTUNG"
            fi
          done <<< "$CHECKSUMS"

            echo "  ‚û°Ô∏è –§–∏–∫—Å fix_allowlist.c.patch"
            patch -p1 < fix_allowlist.c.patch
            # echo "  ‚û°Ô∏è –§–∏–∫—Å fix_apk_sign.c.patch"
            # patch -p1 < fix_apk_sign.c.patch
            echo "  ‚û°Ô∏è –§–∏–∫—Å fix_kernel_umount.c.patch"
            patch -p1 < fix_kernel_umount.c.patch
            echo "  ‚û°Ô∏è –§–∏–∫—Å fix_ksu.c.patch"
            patch -p1 < fix_ksu.c.patch
            echo "  ‚û°Ô∏è –§–∏–∫—Å fix_ksud.c.patch"
            patch -p1 < fix_ksud.c.patch
            echo "  ‚û°Ô∏è –§–∏–∫—Å fix_Makefile.patch"
            patch -p1 < fix_Makefile.patch
            echo "  ‚û°Ô∏è –§–∏–∫—Å fix_selinux.c.patch"
            patch -p1 < fix_selinux.c.patch
            echo "  ‚û°Ô∏è –§–∏–∫—Å fix_sucompat.c.patch"
            patch -p1 < fix_sucompat.c.patch
            echo "  ‚û°Ô∏è –§–∏–∫—Å fix_supercalls.c.patch"
            patch -p1 < fix_supercalls.c.patch

            cd ..
          elif [ "${{ inputs.ksu_type }}" == "5ec1cff" ]; then
            cd KernelSU
            cp ../../susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch ./
            echo "  ‚û°Ô∏è –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ 10_enable_susfs_for_ksu.patch"
            patch -p1 < 10_enable_susfs_for_ksu.patch
            cd ..
          fi

          echo "  ‚û°Ô∏è –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ 50_add_susfs_in_gki-android14-6.1.patch"
          patch -p1 < 50_add_susfs_in_gki-${{ inputs.android_version }}-${{ inputs.kernel_version }}.patch || true
          echo "  üõ†Ô∏è –ß–∏–Ω–∏–º —Ç–æ, —á—Ç–æ —Å–ª–æ–º–∞–ª –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–∞—Ç—á."
          echo "  ‚û°Ô∏è –§–∏–∫—Å sys.c_fix.patch"
          patch -p1 --fuzz=3 < sys.c_fix.patch
          #if [ "${{ inputs.ksu_type }}" == "5ec1cff" ]; then
          #  echo "   ‚û°Ô∏è –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ç—á–∞ exec.c"
          #  cp ../patch/fix_exec.c.patch ./
          #  patch -p1 < fix_exec.c.patch
          #fi

      - name: Adding your own signature
        run: |
          if [ "${{ inputs.ksu_type }}" == "5ec1cff" ]; then
            cd "$CONFIG/KernelSU"
            cp ../../patch/fix_apk_sign.c.5ec1cff.patch ./
            patch -p1 < fix_apk_sign.c.5ec1cff.patch
          elif [ "${{ inputs.ksu_type }}" == "suki-su" ]; then
            cd "$CONFIG/KernelSU"
            sed -i -e 's/^\(#define EXPECTED_SIZE_NEKO\s\+\).*/\1916/' \
                     -e 's/^\(#define EXPECTED_HASH_NEKO\s\+\).*/\1"a72f1296cd4b30901e9c57858d5ce185339e3dde7a91b41a0f2cdf39ffde45af"/' \
                     kernel/manager_sign.h
          elif [ "${{ inputs.ksu_type }}" == "ksu-next" ]; then
            echo "Missing a patch..."
            # cd "$CONFIG/KernelSU-Next"
            # cp ../../patch/fix_apk_sign.c.ksu-next.patch ./
            # patch -p1 < fix_apk_sign.c.ksu-next.patch
          fi

      - name: Getting KernelSU Version
        run: |
          if [ "${{ inputs.ksu_type }}" == "ksu-next" ]; then
            cd "$CONFIG/KernelSU-Next/kernel"
            BASE_VERSION=10200
            COMMIT_COUNT=$(/usr/bin/git rev-list --count HEAD)
          elif [ "${{ inputs.ksu_type }}" == "suki-su" ]; then
            cd "$CONFIG/KernelSU/kernel"
            BASE_VERSION=10700
            COMMIT_COUNT=$(/usr/bin/git rev-list --count origin/HEAD)
          elif [ "${{ inputs.ksu_type }}" == "5ec1cff" ]; then
            cd "$CONFIG/KernelSU/kernel"
            BASE_VERSION=10200
            COMMIT_COUNT=$(/usr/bin/git rev-list --count HEAD)
          fi
          KSU_VERSION=$(expr $COMMIT_COUNT "+" $BASE_VERSION)
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV

      - name: Verify Kernel Version
        run: |
          cd "$CONFIG"
          KERNEL_VER=$(sed -n '2,4p' Makefile | grep -oE '[0-9]+' | paste -sd '.')
          echo "KERNEL_VER=$KERNEL_VER" >> $GITHUB_ENV

          echo "Kernel version detected: ${KERNEL_VER}"

      - name: Add BBG
        run: |
          cd "$CONFIG"
          echo "Adding BBG..."
          wget -O- https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash
          echo "CONFIG_BBG=y" >> ./arch/arm64/configs/${{ inputs.codename }}_defconfig
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/lockdown/lockdown,baseband_guard/ } }' security/Kconfig

      - name: Configure Kernel Options
        run: |
          cd "$CONFIG"

          DEFCONFIG_PATH="$GITHUB_WORKSPACE/android_kernel_google_zuma/arch/arm64/configs/${{ inputs.codename }}_defconfig"
          echo "DEFCONFIG_PATH=$DEFCONFIG_PATH" >> $GITHUB_ENV

          if [ "${{ inputs.ksu_type }}" == "ksu-next" ]; then
            cat $GITHUB_WORKSPACE/bash/kernelsu-next >> "${DEFCONFIG_PATH}"
          elif [ "${{ inputs.ksu_type }}" == "suki-su" ]; then
            cat $GITHUB_WORKSPACE/bash/suki-su >> "${DEFCONFIG_PATH}"
          elif [ "${{ inputs.ksu_type }}" == "5ec1cff" ]; then
            cat $GITHUB_WORKSPACE/bash/5ec1cff >> "${DEFCONFIG_PATH}"
          fi

          cat >> "$DEFCONFIG_PATH" << 'EOF'
          # KernelSU Configuration
          CONFIG_KSU=y
          CONFIG_KSU_KPROBES_HOOK=n

          # Mountify Support
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y

          # Networking Configuration
          CONFIG_IP_NF_TARGET_TTL=y
          CONFIG_IP6_NF_TARGET_HL=y
          CONFIG_IP6_NF_MATCH_HL=y

          # BBR TCP Congestion Control
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_NET_SCH_FQ=y
          CONFIG_TCP_CONG_BIC=n
          CONFIG_TCP_CONG_WESTWOOD=n
          CONFIG_TCP_CONG_HTCP=n

          # IPSet Support
          CONFIG_IP_SET=y
          CONFIG_IP_SET_MAX=65534
          CONFIG_IP_SET_BITMAP_IP=y
          CONFIG_IP_SET_BITMAP_IPMAC=y
          CONFIG_IP_SET_BITMAP_PORT=y
          CONFIG_IP_SET_HASH_IP=y
          CONFIG_IP_SET_HASH_IPMARK=y
          CONFIG_IP_SET_HASH_IPPORT=y
          CONFIG_IP_SET_HASH_IPPORTIP=y
          CONFIG_IP_SET_HASH_IPPORTNET=y
          CONFIG_IP_SET_HASH_IPMAC=y
          CONFIG_IP_SET_HASH_MAC=y
          CONFIG_IP_SET_HASH_NETPORTNET=y
          CONFIG_IP_SET_HASH_NET=y
          CONFIG_IP_SET_HASH_NETNET=y
          CONFIG_IP_SET_HASH_NETPORT=y
          CONFIG_IP_SET_HASH_NETIFACE=y
          CONFIG_IP_SET_LIST_SET=y

          CONFIG_KSU_SUSFS=y
          THREAD_INFO_IN_TASK=y
          EOF

          # Removing defconfig check
          sed -i 's/check_defconfig//' ./build.config.gki

      - name: Apply Performance Patches
        run: |
          cd "$CONFIG"
          cp "../kernel_patches/common/optimized_mem_operations.patch" ./
          patch -p1 --forward < optimized_mem_operations.patch
          cp "../kernel_patches/common/file_struct_8bytes_align.patch" ./
          patch -p1 --forward < file_struct_8bytes_align.patch
          cp "../kernel_patches/common/reduce_cache_pressure.patch" ./
          patch -p1 --forward < reduce_cache_pressure.patch
          cp "../kernel_patches/common/clear_page_16bytes_align.patch" ./
          sed -e 's/SYM_FUNC_START_PI(clear_page)/SYM_FUNC_START_PI(__pi_clear_page)/' clear_page_16bytes_align.patch > clear_page_16bytes_align__pi.patch
          patch -p1 -F3 --forward < clear_page_16bytes_align__pi.patch

#      - name: Start VS Code
#        uses: fawazahmed0/action-debug-vscode@main

      - name: Changing the name to stock
        run: |
          cd "$CONFIG"
          # Removing the dirty label
          sed -i "s/printf '%s' -dirty/printf '%s'/" scripts/setlocalversion
          sed -i 's/android_release=/android_release="android14-6.1"/' scripts/setlocalversion
          sed -i 's/# CONFIG_LOCALVERSION_AUTO is not set/CONFIG_LOCALVERSION_AUTO=y/' arch/arm64/configs/${{ inputs.codename }}_defconfig
          sed -i '/CONFIG_LOCALVERSION="-Sultan"/d' arch/arm64/configs/${{ inputs.codename }}_defconfig

      - name: Build the Kernel
        run: |
          cd "$CONFIG"
          
          # Disable the generation of a fatal error when making warnings.
          echo "# CONFIG_WERROR is not set" >> "./arch/arm64/configs/${{ inputs.codename }}_defconfig"

          make CROSS_COMPILE=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux- CC=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-gcc -j$(nproc --all) ${{ inputs.codename }}_defconfig
          make CROSS_COMPILE=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux- CC=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-gcc -j$(nproc --all)

      - name: Copy Images
        run: |
          cd "$CONFIG"

          echo "  Copying Image.lz4 and concatenating DTB files..."
          cp ./out/arch/arm64/boot/Image.lz4 ../AnyKernel3/Image.lz4
          if [ "${{ inputs.codename }}" == "zuma" ]; then
            cat ./out/google-devices/zuma/dts/*.dtb > ../AnyKernel3/dtb
          fi

      - name: Create ZIP Files for Different Formats
        run: |
          cd ./AnyKernel3

          # Zip the files in the AnyKernel3 directory with a new naming convention
          ZIP_NAME="${KERNEL_VER}-${{ inputs.codename }}-${{ inputs.ksu_type }}-v$KSUVER-AnyKernel3.zip"
          echo "Creating zip file $ZIP_NAME..."
          zip -r "../$ZIP_NAME" ./*

      - name: Create boot.img
        run: |
          set -x
          MAGISKBOOT=$GITHUB_WORKSPACE/Prebuilds/magiskboot_v30.2
          chmod +x "$MAGISKBOOT"
          BOOTIMG=$GITHUB_WORKSPACE/Prebuilds/boot.img
          VENDOR=$GITHUB_WORKSPACE/Prebuilds/vendor_kernel_boot.img
          TMP_DIR=tmp_dir
          mkdir tmp_dir

          BOOT_NAME="${KERNEL_VER}-${{ inputs.codename }}-${{ inputs.ksu_type }}-v$KSUVER-boot.img"
          VENDOR_BOOT_NAME="${KERNEL_VER}-${{ inputs.codename }}-${{ inputs.ksu_type }}-v$KSUVER-vendor_kernel_boot.img"

          unzip $GITHUB_WORKSPACE/Prebuilds/stock_img_shusky.zip -d $GITHUB_WORKSPACE/Prebuilds/

          cp $CONFIG/out/arch/arm64/boot/Image.lz4 .
          cat $CONFIG/out/google-devices/zuma/dts/*.dtb > dtb
          
          cd tmp_dir
          "$MAGISKBOOT" unpack "$BOOTIMG"
          cp ../Image.lz4 kernel
          "$MAGISKBOOT" repack "$BOOTIMG" ../$BOOT_NAME
          rm -rf ./*
          "$MAGISKBOOT" unpack "$VENDOR"
          cp ../dtb dtb
          "$MAGISKBOOT" repack "$VENDOR" ../$VENDOR_BOOT_NAME
          
      - name: Upload AK3.zip
        uses: actions/upload-artifact@v4
        with:
          name: AK3-${{ inputs.codename }}-${{ inputs.ksu_type }}
          path: |
            *.zip

      - name: Upload img's
        uses: actions/upload-artifact@v4
        with:
          name: flashable-img-${{ inputs.codename }}-${{ inputs.ksu_type }}
          path: |
            *.img

      - name: Scan and collect patch rejects
        if: ${{ always() }}
        run: |
          set -e
          CONFIG_DIR="$CONFIG"
          REJECTS_DIR="$GITHUB_WORKSPACE/patch-rejects"
          mkdir -p "$REJECTS_DIR"
          # Find all .rej files under the configuration directory
          mapfile -t REJS < <(find "$CONFIG_DIR" -type f -name '*.rej')
          REJ_COUNT=${#REJS[@]}
          echo "Found $REJ_COUNT .rej files under $CONFIG_DIR"
          echo "REJ_COUNT=$REJ_COUNT" >> $GITHUB_ENV
          if [ "$REJ_COUNT" -gt 0 ]; then
            for REJ in "${REJS[@]}"; do
              # Relative path from $CONFIG
              REL="${REJ#"$CONFIG_DIR"/}"
              DEST="$REJECTS_DIR/$REL"
              mkdir -p "$(dirname "$DEST")"
              cp "$REJ" "$DEST"
              # Copy the associated original file alongside the .rej
              ORIG="${REJ%.rej}"
              if [ -f "$ORIG" ]; then
                ORIG_DEST="$REJECTS_DIR/${REL%.rej}"
                mkdir -p "$(dirname "$ORIG_DEST")"
                cp "$ORIG" "$ORIG_DEST"
              fi
              echo "$REL" >> "$REJECTS_DIR/index.txt"
            done
          fi

      - name: Extra Artifacts
        if: ${{ always() }}
        id: upload_misc
        uses: actions/upload-artifact@v4
        with:
          name: Misc-${{ inputs.codename }}-${{ inputs.ksu_type }}
          path: |
            patch-rejects/**
          if-no-files-found: ignore
          compression-level: 9